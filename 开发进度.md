# BBDM åŠ¨æ¼«çº¿ç¨¿ç€è‰²ç³»ç»Ÿ - å¼€å‘è¿›åº¦

> åŸºäºé¡¹ç›®æŒ‡å¯¼ä¹¦çš„å®ç°è¿›åº¦è¿½è¸ª
> å¼€å§‹æ—¥æœŸï¼š2026å¹´1æœˆ12æ—¥

---

## âœ… å·²å®Œæˆ

### 1. æ•°æ®å±‚å®ç° (2026-01-12)

#### 1.1 TPS å˜å½¢æ¨¡å— (`datasets/tps_warp.py`)
- âœ… æ·»åŠ  `distortion_scale` å‚æ•°ï¼Œæ”¯æŒåŠ¨æ€æ§åˆ¶å˜å½¢å¼ºåº¦
- âœ… å®šä¹‰ `TPS_CURRICULUM_STAGES` è¯¾ç¨‹å­¦ä¹ é…ç½®ï¼š
  - é˜¶æ®µ1: 0.05 (è½»å¾®å˜å½¢)
  - é˜¶æ®µ2: 0.15 (ä¸­ç­‰å˜å½¢)
  - é˜¶æ®µ3: 0.30 (è¾ƒå¼ºå˜å½¢)
- âœ… å®ç° `get_tps_scale_for_stage(stage)` å·¥å…·å‡½æ•°

#### 1.2 æ ¸å¿ƒæ•°æ®é›† (`datasets/custom.py`)

**A. `LineartColorizationDataset`** (æ³¨å†Œå: `custom_lineart_colorization`)
- âœ… æ”¯æŒä¸‰å…ƒç»„æ•°æ®åŠ è½½ï¼š`{L, I_warped, I_gt}`
- âœ… é›†æˆ TPS è¯¾ç¨‹å­¦ä¹ ï¼š
  - é…ç½®é¡¹ï¼š`tps_scale` æˆ– `curriculum_stage`
  - è¿è¡Œæ—¶åŠ¨æ€è°ƒèŠ‚ï¼š`set_tps_scale()` / `set_curriculum_stage()`
- âœ… æ•°æ®å¢å¼ºï¼šéšæœºç¿»è½¬ã€å½’ä¸€åŒ–åˆ° [-1, 1]
- âœ… ç›®å½•ç»“æ„éªŒè¯ä¸æ–‡ä»¶ä¸€è‡´æ€§æ£€æŸ¥

**B. `LineartSelfReferenceDataset`** (æ³¨å†Œå: `custom_lineart_self_reference`)
- âœ… è‡ªå‚è€ƒå¢å¼ºæ¨¡å¼ï¼ˆç”¨äºé˜¶æ®µ1è®­ç»ƒï¼‰
- âœ… Canny è¾¹ç¼˜æ£€æµ‹è‡ªåŠ¨æå–çº¿ç¨¿
- âœ… è½»å¾® TPS å˜å½¢ç”Ÿæˆå‚è€ƒå›¾ (é»˜è®¤ scale=0.05)
- âœ… é…ç½®é¡¹ï¼š`canny_low`, `canny_high`, `tps_scale`

#### 1.3 ä¾èµ–ä¸å¯¼å…¥ä¼˜åŒ–
- âœ… æ·»åŠ  `numpy` å¯¼å…¥
- âœ… ä½¿ç”¨ `TF` (torchvision.transforms.functional) åˆ«åç®€åŒ–ä»£ç 
- âœ… å®Œå–„ç±»å‹æç¤ºæ”¯æŒ

---

## ğŸš§ è¿›è¡Œä¸­

### VQGAN å¾®è°ƒ (2026-01-12)
- **é—®é¢˜å‘ç°**: é¢„è®­ç»ƒ VQGAN åœ¨åŠ¨æ¼«æ•°æ®ä¸Š PSNR ä»… 16.84 dBï¼ˆè¿œä½äºå¯æ¥å—çš„ 25 dBï¼‰
- **åŸå› åˆ†æ**: é¢„è®­ç»ƒæƒé‡åŸºäºè‡ªç„¶å›¾åƒï¼Œæ— æ³•æœ‰æ•ˆè¡¨ç¤ºåŠ¨æ¼«å›¾åƒçš„å¹³å¦è‰²å—å’Œé”åˆ©è¾¹ç¼˜
- **è§£å†³æ–¹æ¡ˆ**: éœ€è¦åœ¨åŠ¨æ¼«æ•°æ®é›†ä¸Šå¾®è°ƒ VQGAN
- **å·²åˆ›å»ºæ–‡ä»¶**:
  - `scripts/finetune_vqgan.py` - å¾®è°ƒè„šæœ¬
  - `configs/finetune_vqgan.yaml` - å¾®è°ƒé…ç½®
- [ ] æ‰§è¡Œå¾®è°ƒè®­ç»ƒ
- [ ] éªŒè¯å¾®è°ƒåçš„é‡å»ºè´¨é‡ (ç›®æ ‡ PSNR >= 28 dB)

---

## ğŸ“‹ å¾…å®Œæˆ

### 2. UCE-Lite v2 ç»Ÿä¸€æ¡ä»¶ç¼–ç å™¨
- [ ] åˆ›å»º `model/encoder/uce_lite_v2.py`
  - [ ] å®ç°åŒå¡”æ¶æ„ (Lineart Tower + Reference Tower)
  - [ ] å®ç° `StableCrossAttention` æœºåˆ¶
  - [ ] å®ç°é‡‘å­—å¡”è¾“å‡ºå¤´ (style_vec, p2, p3)
- [ ] æ³¨å†Œåˆ° `Register.py`

### 3. æ¡ä»¶æ³¨å…¥æœºåˆ¶
- [ ] åˆ›å»º `model/BrownianBridge/injection/`
  - [ ] `base_injection.py`: AdaIN, FiLM, CrossAttention åŸºç±»
  - [ ] `injection_manager.py`: ç»Ÿä¸€æ³¨å…¥ç®¡ç†å™¨
- [ ] ä¿®æ”¹ U-Net æ”¯æŒå¤šè·¯æ³¨å…¥
  - [ ] åˆ›å»º `model/BrownianBridge/base/modules/unet_uce.py`
  - [ ] ä¿®æ”¹ ResBlock æ”¯æŒ AdaIN/FiLM

### 4. Latent BBDM é›†æˆ
- [ ] åˆ›å»º `model/BrownianBridge/LatentBBDM_UCE.py`
- [ ] é›†æˆ UCE-Lite v2 æ¡ä»¶ç¼–ç å™¨
- [ ] å®ç°ä¸‰è·¯æ¡ä»¶ä¼ é€’åˆ° U-Net

### 5. è¾¹ç¼˜ç»†åŒ–æ¨¡å—
- [ ] åˆ›å»º `model/refinement/adaptive_edge_refinement.py`
- [ ] Sobel è¾¹ç¼˜æ£€æµ‹ + ResNet èåˆ

### 6. è®­ç»ƒ Runner
- [ ] åˆ›å»º `runners/LineartColorRunner.py`
- [ ] å®ç°å››é˜¶æ®µè¯¾ç¨‹å­¦ä¹ é€»è¾‘
- [ ] æ¨¡å—å†»ç»“/è§£å†»æ§åˆ¶
- [ ] æŸå¤±æƒé‡åŠ¨æ€è°ƒæ•´

### 7. é…ç½®ä¸æµ‹è¯•
- [ ] åˆ›å»º `configs/AnimeLineartColor.yaml`
- [ ] æ³¨å†Œæ‰€æœ‰æ–°ç»„ä»¶åˆ° `Register.py`
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

---

## ğŸ“ å…³é”®å†³ç­–è®°å½•

### æ•°æ®é›†è®¾è®¡
- **å†³ç­–**: ä½¿ç”¨å­—å…¸è¿”å›æ ¼å¼ `{'L', 'I_warped', 'I_gt', 'filename'}` è€Œéå…ƒç»„
- **ç†ç”±**: ä¾¿äºæ‰©å±•å’Œæ¸…æ™°çš„é”®å€¼å¯¹åº”ï¼ŒRunner ä¸­æ›´æ˜“è¯»

### TPS è¯¾ç¨‹å­¦ä¹ 
- **å†³ç­–**: æ”¯æŒä¸¤ç§é…ç½®æ–¹å¼ (`tps_scale` ç›´æ¥å€¼ / `curriculum_stage` é˜¶æ®µæ˜ å°„)
- **ç†ç”±**: æ—¢æ”¯æŒç²¾ç»†æ§åˆ¶ï¼Œåˆæä¾›å¼€ç®±å³ç”¨çš„é¢„è®¾

### è‡ªå‚è€ƒå¢å¼º
- **å†³ç­–**: ç‹¬ç«‹æ•°æ®é›† `LineartSelfReferenceDataset` è€Œéåœ¨ä¸»æ•°æ®é›†ä¸­åˆ‡æ¢æ¨¡å¼
- **ç†ç”±**: èŒè´£åˆ†ç¦»ï¼Œé¿å… if-else é€»è¾‘å¤æ‚åŒ–ï¼Œä¾¿äºé˜¶æ®µ1å•ç‹¬è®­ç»ƒ

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- é¡¹ç›®æŒ‡å¯¼ä¹¦: `é¡¹ç›®æŒ‡å¯¼ä¹¦.md`
- Copilot æŒ‡ä»¤: `.github/copilot-instructions.md`
- åŸå§‹ README: `readme.md`

---

## ğŸ“Š å½“å‰è¿›åº¦

- æ•°æ®å±‚: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% (2/2)
- æ¨¡å‹å±‚: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% (0/4)
- è®­ç»ƒå±‚: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% (0/2)
- æ€»ä½“è¿›åº¦: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  25% (2/8)
